{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel unificado</title>
  <link rel="icon" href="{% static 'academia_core/escudo-ipes.png' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
   :root{
    --ink:#2e2f33; --bg:#ebd4c5; --card:#fff; --card-b:#e9e4da;
    --orange:#e8892a; --orange-600:#d37517;
    --green:#3e7d59; --green-600:#2e6446; --green-050:#eaf3ef;
    --muted:#6f7a83; --radius:16px; --gap:16px; --shadow:0 8px 26px rgba(23,36,44,.08);
   }
   *{ box-sizing:border-box }
   body{ margin:0; background:var(--bg); color:var(--ink);
        font:16px/1.5 "Inter","Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;
        -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale }
   a{ color:var(--green-600); text-decoration:none }
   a:hover{ text-decoration:underline }
   .wrap{ max-width:1400px; margin:0 auto; padding:20px }
   .topbar{ display:flex; justify-content:flex-end; gap:10px; margin-bottom:var(--gap) }
   .btn{ background:#fff; border:1px solid var(--card-b); color:var(--green-600);
         padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)}
   .btn:hover{ background:var(--green-050) }
   .card{ background:var(--card); border:1px solid var(--card-b);
          border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}

   /* ======= HERO ======= */
   .hero{ display:grid; grid-template-columns:1fr 128px 1fr; align-items:center; gap:16px; margin-bottom:var(--gap) }
   .brand-big{ font-size:64px; line-height:.9; letter-spacing:3px; font-weight:700 }
   .brand-sub{ font-weight:600; color:var(--muted); letter-spacing:6px }
   .hero .center{ justify-self:center }
   .hero .center img{ max-height:100px; transform:scale(1.35); filter:drop-shadow(0 2px 6px rgba(0,0,0,.12)) }
   .hero-user{ text-align:right; display:flex; flex-direction:column; gap:6px; align-items:flex-end }
   .pill{ display:inline-block; background:var(--green-050); color:var(--green-600); padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #d4e5dd }

   .grid{ display:grid; grid-template-columns:260px 1fr 320px; gap:var(--gap) }
   @media (max-width:1100px){ .grid{ grid-template-columns:1fr } .right{ order:3 } .left{ order:2 } .center{ order:1 } }

   .sidenav h3{ margin:0 0 10px }
   .menu-list{ list-style:none; margin:0; padding:0 }
   .menu-item{ margin:2px 0 }
   .menu-link{ display:block; padding:10px 12px; border-radius:10px; font-weight:600; color:var(--ink) }
   .menu-link:hover{ background:#f3f6f4 }
   .menu-link.active{ background:var(--green-050); outline:2px solid #d9ebe3 }

   .section-links{ list-style:none; padding:0; margin:8px 0 0 }
   .divider{ border:none; border-top:1px solid var(--card-b); margin:14px 0 }

   input,select,textarea{ width:100%; padding:10px 12px; border:1px solid #d9e0e4; border-radius:12px }
   input:focus,select:focus{ outline:2px solid var(--green) }
   label{ display:block; margin-top:10px }
   .muted{ color: var(--muted); }
   .submit{ margin-top:16px }
   .submit button{ background:var(--orange); border:0; color:#2b1b09; padding:12px 16px; border-radius:12px }
   .submit button:hover{ background:var(--orange-600) }
   .msg{ margin:8px 0; background:#f1f5f2; border:1px solid var(--card-b); padding:12px; border-radius:12px }
  </style>

  {# ======= CSS: Alta de estudiante (2 columnas) ======= #}
  {% if action == "add_est" %}
  <style>
    #add-est-grid{display:grid!important;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px 24px;align-items:start}
    #add-est-grid .item{margin:0}
    #add-est-grid label{display:block;font-weight:600;margin-bottom:6px}
    #add-est-grid input[type="text"],#add-est-grid input[type="email"],#add-est-grid input[type="tel"],#add-est-grid input[type="date"],#add-est-grid input[type="number"],#add-est-grid input[type="file"],#add-est-grid select,#add-est-grid textarea{width:100%;box-sizing:border-box}
    #add-est-grid .full{grid-column:1/-1}
    #add-est-grid .check{display:flex;align-items:center;gap:8px}
    #add-est-grid .check input[type="checkbox"]{width:auto!important;height:auto;margin:0;flex:0 0 auto}
    #add-est-grid .check label{display:inline-block;margin:0;font-weight:600}
    .err{color:#b00020;margin-top:4px;font-size:.9rem}
    @media (max-width:900px){#add-est-grid{grid-template-columns:1fr}}
  </style>
  {% endif %}

  {# ======= CSS: Inscribir carrera ======= #}
  {% if action == "insc_prof" %}
  <style>
    #insc-prof-grid-top{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px 24px;align-items:start}
    #insc-prof-grid-top label{display:block;font-weight:600;margin-bottom:6px}
    #insc-prof-grid-top input,#insc-prof-grid-top select,#insc-prof-grid-top textarea{width:100%}

    #insc-prof-checks{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px 18px;
      align-items:start;
      margin-top:12px;
    }
    #insc-prof-checks .chk{
      display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;
      height:72px;padding:10px 12px;border:1px solid #e6e3dd;border-radius:10px;background:#fafafa;overflow:hidden;line-height:1.25
    }
    #insc-prof-checks .chk input[type="checkbox"]{width:auto;height:auto;margin:0 0 6px 0;flex:0 0 auto}
    #insc-prof-checks .chk label{margin:0;font-weight:600}

    #insc-prof-extra{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px 24px;align-items:start;margin-top:12px}
    #insc-prof-extra label{display:block;font-weight:600;margin-bottom:6px}
    #insc-prof-extra input,#insc-prof-extra select,#insc-prof-extra textarea{width:100%}
    .err{color:#b00020;margin-top:4px;font-size:.9rem}
    @media (max-width:900px){
      #insc-prof-grid-top{grid-template-columns:1fr}
      #insc-prof-checks{grid-template-columns:1fr 1fr}
      #insc-prof-extra{grid-template-columns:1fr}
    }
  </style>
  {% endif %}

  {# ======= CSS: Inscribir a materia (cursada) ======= #}
  {% if action == "insc_esp" %}
  <style>
    #insc-esp-grid-top{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px 24px;align-items:start
    }
    #insc-esp-grid-top label{display:block;font-weight:600;margin-bottom:6px}
    #insc-esp-grid-top input,#insc-esp-grid-top select{width:100%}
    #correl-box{margin-top:12px;border:1px solid #e6e3dd;border-radius:12px;padding:12px;background:#fafafa}
    #correl-box h5{margin:0 0 8px;font-size:14px}
    #correl-box ul{margin:0;padding-left:18px}
    #correl-box li{margin:4px 0}
    .muted{color:#6f7a83}
    @media (max-width:900px){#insc-esp-grid-top{grid-template-columns:1fr}}
  </style>
  {% endif %}
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <a class="btn" href="{{ logout_url }}">Cerrar sesión</a>
    <a class="btn" href="{{ login_url }}">Cambiar usuario</a>
  </div>

  <div class="hero card">
    <div>
      <div class="brand-big">IPES</div>
      <div class="brand-sub">PAULO FREIRE</div>
    </div>
    <div class="center"><img src="{% static 'academia_core/escudo-ipes11.png' %}" alt="Escudo IPES"></div>
    <div class="hero-user">
      <div>Usuario: <strong>{{ request.user.username }}</strong></div>
      <div>Rol: <span class="pill">{{ rol }}</span></div>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="msg {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
  {% if request.GET.ok == '1' %}
    <div class="msg success">Guardado correctamente.</div>
  {% endif %}

  <div class="grid">
    <aside class="left card sidenav">
      <h3>Acciones</h3>
      <ul class="menu-list">
        <li class="menu-item"><a href="?action=section_est" class="menu-link {% if action == 'section_est' or action == 'add_est' %}active{% endif %}">Estudiantes</a></li>
        <li class="menu-item"><a href="?action=section_insc" class="menu-link {% if action == 'section_insc' or action == 'insc_prof' or action == 'insc_esp' or action == 'insc_final' %}active{% endif %}">Inscripciones</a></li>
        <li class="menu-item"><a href="?action=section_calif" class="menu-link {% if action == 'section_calif' or action == 'cargar_cursada' or action == 'cargar_nota_final' or action == 'cargar_final_resultado' %}active{% endif %}">Calificaciones</a></li>
        {% if can_admin %}
        <li class="menu-item"><a href="?action=section_admin" class="menu-link {% if action == 'section_admin' or action == 'espacios_admin' or action == 'correlativas' or action == 'prof_new' or action == 'plan_new' or action == 'admin_rename' or action == 'admin_delete' %}active{% endif %}">Administración</a></li>
        {% endif %}
        <li class="menu-item"><a href="?action=section_help" class="menu-link {% if action == 'section_help' %}active{% endif %}">Ayuda</a></li>
      </ul>
    </aside>

    <main class="center card">
      <h3>{{ action_title }}</h3>
      {% if action_subtitle %}<p class="muted">{{ action_subtitle|safe }}</p>{% endif %}

      {% if action == 'section_est' %}
        <h4>Estudiantes</h4>
        <ul class="section-links">
          <li><a href="?action=add_est">➜ Nuevo estudiante</a></li>
        </ul>

      {% elif action == 'section_insc' %}
        <h4>Inscripciones</h4>
        <ul class="section-links">
          <li><a href="?action=insc_prof">➜ Inscribir a carrera</a></li>
          <li><a href="?action=insc_esp">➜ Inscribir a materia (cursada)</a></li>
          <li><a href="?action=insc_final">➜ Inscribir a mesa de final</a></li>
        </ul>

      {% elif action == 'section_calif' %}
        <h4>Calificaciones</h4>
        <ul class="section-links">
          <li><a href="?action=cargar_cursada">➜ Cargar cursada</a></li>
          <li><a href="?action=cargar_nota_final">➜ Cargar nota de final</a></li>
          <li><a href="?action=cargar_final_resultado">➜ Registrar resultado final</a></li>
        </ul>

      {% elif action == 'section_admin' and can_admin %}
        <h4>Administración</h4>
        <ul class="section-links">
          <li><a href="?action=espacios_admin">➜ Espacios curriculares</a></li>
          <li><a href="?action=correlativas">➜ Correlatividades</a></li>
          <li><a href="?action=prof_new">➜ Crear profesorado</a></li>
          <li><a href="?action=plan_new">➜ Crear plan</a></li>
          <li><a href="?action=admin_rename">➜ Renombrar entidades</a></li>
          <li><a href="?action=admin_delete">➜ Eliminar entidades</a></li>
        </ul>

      {% elif action == 'section_help' %}
        <h4>Ayuda</h4>
        <p class="muted">¿Encontraste un problema?</p>
        <a href="mailto:soporte@ejemplo.edu">➜ Reportar bug</a>

      {% elif form %}
        {% if bloquear_guardar %}
          <p class="muted">No tenés permisos de edición para esta acción.</p>
        {% else %}
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="action" value="{{ action }}">

            {% if form.non_field_errors %}
              <div class="msg" role="alert">{{ form.non_field_errors }}</div>
            {% endif %}

            {# ===== Alta de estudiante ===== #}
            {% if action == "add_est" %}
              <div id="add-est-grid">
                <div class="item">{{ form.dni.label_tag }}{{ form.dni }}{% for e in form.dni.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item">{{ form.apellido.label_tag }}{{ form.apellido }}{% for e in form.apellido.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item">{{ form.nombre.label_tag }}{{ form.nombre }}{% for e in form.nombre.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item">{{ form.fecha_nacimiento.label_tag }}{{ form.fecha_nacimiento }}{% for e in form.fecha_nacimiento.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item">{{ form.lugar_nacimiento.label_tag }}{{ form.lugar_nacimiento }}{% for e in form.lugar_nacimiento.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item">{{ form.email.label_tag }}{{ form.email }}{% for e in form.email.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item">{{ form.telefono.label_tag }}{{ form.telefono }}{% for e in form.telefono.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item">{{ form.localidad.label_tag }}{{ form.localidad }}{% for e in form.localidad.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item full check">{{ form.activo }} {{ form.activo.label_tag }}{% for e in form.activo.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                <div class="item full">{{ form.foto.label_tag }}{{ form.foto }}{% for e in form.foto.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
              </div>

            {% elif action == "insc_prof" %}
              <!-- Top en 2 columnas -->
              <div id="insc-prof-grid-top">
                {% for f in form %}
                  {% if f.name == 'estudiante' or f.name == 'profesorado' or f.name == 'cohorte' or f.name == 'anio_academico' or f.name == 'ubicacion' or f.name == 'sede' or f.name == 'ubica' or f.name == 'curso_introductorio' %}
                    <div>{{ f.label_tag }}{{ f }}{% for e in f.errors %}<div class="err">{{ e }}</div>{% endfor %}</div>
                  {% endif %}
                {% endfor %}
              </div>

              <!-- Checkboxes en 3 columnas -->
              <div id="insc-prof-checks">
                {% for f in form %}
                  {% if f.field.widget.input_type == 'checkbox' and f.name != 'activo' %}
                    <label class="chk">{{ f }} {{ f.label }}</label>
                  {% endif %}
                {% endfor %}
              </div>

              <!-- ¿Cuáles? + Colegio -->
              <div id="insc-prof-extra">
                {% if form.adeuda_detalle %}
                  <div class="js-adeuda-field">
                    {{ form.adeuda_detalle.label_tag }}{{ form.adeuda_detalle }}
                    {% for e in form.adeuda_detalle.errors %}<div class="err">{{ e }}</div>{% endfor %}
                  </div>
                {% endif %}
                {% if form.colegio %}
                  <div class="js-adeuda-field">
                    {{ form.colegio.label_tag }}{{ form.colegio }}
                    {% for e in form.colegio.errors %}<div class="err">{{ e }}</div>{% endfor %}
                  </div>
                {% endif %}
              </div>

              {# Catch-all: campos no renderizados arriba #}
              {% for f in form %}
                {% if f.field.widget.input_type != 'checkbox' and f.name != 'estudiante' and f.name != 'profesorado' and f.name != 'cohorte' and f.name != 'anio_academico' and f.name != 'ubicacion' and f.name != 'sede' and f.name != 'ubica' and f.name != 'curso_introductorio' and f.name != 'adeuda_detalle' and f.name != 'colegio' %}
                  <label>{{ f.label }}</label>{{ f }}{% for e in f.errors %}<div class="err">{{ e }}</div>{% endfor %}
                {% endif %}
              {% endfor %}

            {% elif action == "insc_esp" %}
              <!-- Top en 2 columnas -->
              <div id="insc-esp-grid-top">
                {% for f in form %}
                  {% if f.name == 'inscripcion' or f.name == 'anio_academico' or f.name == 'espacio' %}
                    <div>
                      {{ f.label_tag }}{{ f }}
                      {% for e in f.errors %}<div class="err">{{ e }}</div>{% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>

              <!-- Caja de correlatividades -->
              <div id="correl-box">
                <h5>Correlatividades</h5>
                <ul id="correl-list">
                  <li class="muted">(Sin correlatividades definidas)</li>
                </ul>
              </div>

              {# Cualquier otro campo “extra” no incluido arriba #}
              {% for f in form %}
                {% if f.name != 'inscripcion' and f.name != 'anio_academico' and f.name != 'espacio' and f.field.widget.input_type != 'checkbox' %}
                  <label>{{ f.label }}</label>{{ f }}
                  {% for e in f.errors %}<div class="err">{{ e }}</div>{% endfor %}
                {% endif %}
              {% endfor %}

            {% else %}
              {# Resto: render genérico #}
              {% if form.inscripcion %}{{ form.inscripcion.label_tag }}{{ form.inscripcion }}{% endif %}
              {% if form.espacio %}{{ form.espacio.label_tag }}{{ form.espacio }}{% endif %}
              {% if form.anio_academico %}{{ form.anio_academico.label_tag }}{{ form.anio_academico }}{% endif %}
              {% for f in form %}
                {% if f.name != 'inscripcion' and f.name != 'espacio' and f.name != 'anio_academico' %}
                  {{ f.label_tag }}{{ f }}
                {% endif %}
              {% endfor %}
            {% endif %}

            <div class="submit"><button type="submit" name="save" value="1">Guardar</button></div>
          </form>
        {% endif %}
      {% endif %}
    </main>

    <aside class="right card">
      <h3>Profesorados disponibles</h3>
      {% if profesorados %}
        <ul>
          {% for p in profesorados %}
            <li><strong>{{ p.nombre }}</strong><br><span class="muted">Plan: {{ p.plan_vigente }}</span></li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">Sin profesorados.</p>
      {% endif %}
    </aside>
  </div>
</div>

<style>.hidden{display:none!important}</style>

<script>
(function () {
  // Helpers
  function qs(name){return document.querySelector('[name="'+name+'"]');}
  function wrap(el){return el?.closest('p') || el?.parentElement || el?.closest('div');}
  function showField(el,show){if(!el)return;const b=wrap(el)||el;b.style.display=show?'':'none';}
  function disableField(el,disabled,clear=true){if(!el)return;el.disabled=!!disabled;if(disabled&&clear)el.value='';}

  // ===== Lógica de finales (si existiera en otros forms) =====
  const nota = qs('nota_final') || qs('nota_num') || qs('nota');
  const ausente = qs('ausente');
  const justif = qs('ausencia_justificada');
  const condicion = qs('condicion');
  const notaTexto = qs('nota_texto');
  const dispoInt = qs('disposicion_interna');
  function syncUI(){
    const isAus = !!(ausente && ausente.checked);
    const cond = condicion ? condicion.value : null;
    const isEq = (cond === 'Equivalencia');
    if(condicion){
      showField(notaTexto,isEq); showField(dispoInt,isEq);
      showField(ausente,!isEq); showField(justif,!isEq && isAus);
      showField(nota,!isEq && !isAus); disableField(nota, isEq || isAus);
    }else{
      disableField(nota,isAus); showField(nota,!isAus); showField(justif,isAus);
    }
    if(nota && !nota._hasRangeListener){
      nota.setAttribute('min','0'); nota.setAttribute('max','10');
      nota.addEventListener('input',function(){
        if(this.value===''){this.setCustomValidity('');return;}
        let v=parseFloat(String(this.value).replace(',','.'));
        if(isNaN(v)||v<0||v>10){this.setCustomValidity('La nota debe estar entre 0 y 10.');}
        else{this.setCustomValidity('');}
      });
      nota._hasRangeListener = true;
    }
  }
  ausente && ausente.addEventListener('change',syncUI);
  justif && justif.addEventListener('change',syncUI);
  condicion && condicion.addEventListener('change',syncUI);
  document.addEventListener('DOMContentLoaded',syncUI); syncUI();

  // ===== Inscribir carrera (insc_prof) =====
  const adeuda = document.querySelector('input[type="checkbox"][name="adeuda_materias"]');
  const adeudaDetalle = document.querySelector('[name="adeuda_detalle"]');
  const colegio = document.querySelector('[name="colegio"]');
  function toggleAdeuda(){
    const on = !!(adeuda && adeuda.checked);
    showField(adeudaDetalle, on); disableField(adeudaDetalle, !on, false);
    showField(colegio, on);       disableField(colegio, !on, false);
  }
  adeuda && adeuda.addEventListener('change', toggleAdeuda);

  const selProf   = document.querySelector('[name="profesorado"]');
  const tituloSup = document.querySelector('[name="doc_titulo_superior_legalizado"]');
  const incumb    = document.querySelector('[name="doc_incumbencias_titulo"]');
  const tituloSec = document.querySelector('[name="doc_titulo_sec_legalizado"]');
  function esCertificacionDocente(){
    if(!selProf) return false;
    const t = (selProf.options[selProf.selectedIndex]?.text || '').toLowerCase();
    return t.includes('certificación docente') || t.includes('certificacion docente');
  }
  function toggleCertificacion(){
    const cert = esCertificacionDocente();
    showField(tituloSup, cert); disableField(tituloSup, !cert, false);
    showField(incumb, cert);    disableField(incumb, !cert, false);
    if (tituloSec){ showField(tituloSec, !cert); disableField(tituloSec, cert, false); }
  }
  selProf && selProf.addEventListener('change', toggleCertificacion);

  if (document.querySelector('[name="action"]')?.value === 'insc_prof') {
    toggleAdeuda();
    toggleCertificacion();
  }

  // ===== Inscribir a materia (insc_esp) =====
  const actionInput = document.querySelector('[name="action"]');
  const espacioSel = document.getElementById('espacio-select') || document.querySelector('[name="espacio"]');
  const correlList = document.getElementById('correl-list');
  {% if correl_map %}
    window.CORREL_MAP = {{ correl_map|safe }};
  {% else %}
    window.CORREL_MAP = {};
  {% endif %}

  function renderCorrels(){
    if(!espacioSel || !correlList) return;
    const id = String(espacioSel.value || '');
    const items = window.CORREL_MAP[id] || [];
    correlList.innerHTML = '';
    if(!items.length){
      correlList.innerHTML = '<li class="muted">(Sin correlatividades definidas)</li>';
      return;
    }
    for(const it of items){
      const li = document.createElement('li');
      li.textContent = `${it.tipo}: ${it.nombre}`;
      correlList.appendChild(li);
    }
  }

  if (actionInput && actionInput.value === 'insc_esp') {
    // (1) AUTOSUBMIT al cambiar Inscripción + bloqueo/rehabilitación del combo Espacio
    const inscSel = document.querySelector('[name="inscripcion"]');
    function lockEspacio(lock){ if(espacioSel){ espacioSel.disabled = !!lock; } }
    lockEspacio(!inscSel || !inscSel.value);

    if (inscSel) {
      inscSel.addEventListener('change', function(){
        lockEspacio(true);
        const form = inscSel.form;
        const tmp = document.createElement('input');
        tmp.type = 'hidden';
        tmp.name = 'refresh';
        tmp.value = '1';
        form.appendChild(tmp);
        form.requestSubmit ? form.requestSubmit() : form.submit();
      });
    }

    // (2) correlatividades
    espacioSel && espacioSel.addEventListener('change', renderCorrels);
    renderCorrels();
  }
})();
</script>
</body>
</html>
